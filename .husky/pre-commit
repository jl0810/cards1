#!/usr/bin/env sh

echo "üîç Running pre-commit checks..."

# 1. Type check production code (excludes test files)
echo "‚Üí Type checking production code..."
npx tsc --noEmit --project tsconfig.production.json || exit 1

# 2. Lint and format staged files (NOW INCLUDES 'any' TYPE CHECKING!)
echo "‚Üí Linting and formatting..."
npx lint-staged || exit 1

# 3. Run unit tests
echo "‚Üí Running unit tests..."
npm test -- --passWithNoTests --bail || exit 1

# 4. Validate documentation
echo "‚Üí Validating documentation..."
node scripts/validate-docs.mjs || exit 1

# 5. Check for 'use client' in page.tsx or layout.tsx (Leaf Pattern)
echo "‚Üí Checking Leaf Pattern compliance..."
STAGED_FILES=$(git diff --cached --name-only)
CLIENT_IN_PAGES=$(echo "$STAGED_FILES" | grep -E "app/.*/page\.tsx|app/.*/layout\.tsx" | xargs grep -l "'use client'" 2>/dev/null || true)

if [ -n "$CLIENT_IN_PAGES" ]; then
  echo "‚ùå ERROR: Found 'use client' in page.tsx or layout.tsx"
  echo "Files:"
  echo "$CLIENT_IN_PAGES"
  echo ""
  echo "‚ö†Ô∏è  Violates Leaf Pattern - push 'use client' to leaf components only"
  exit 1
fi

# 6. Additional type safety check for explicit 'any' (belt-and-suspenders)
echo "‚Üí Double-checking for explicit 'any' types..."
STAGED_TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.tsx?$' | grep -v '__tests__' | grep -v '.test.ts' | grep -v 'node_modules')
if [ -n "$STAGED_TS_FILES" ]; then
  ANY_COUNT=$(echo "$STAGED_TS_FILES" | xargs grep -n ': any' 2>/dev/null | wc -l | xargs)
  if [ "$ANY_COUNT" -gt 0 ]; then
    echo "‚ö†Ô∏è  WARNING: Found $ANY_COUNT explicit 'any' type(s) in staged files"
    echo "    ESLint should have caught these - check eslint.config.js"
  fi
fi

echo "‚úÖ All pre-commit checks passed!"

