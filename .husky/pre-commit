#!/usr/bin/env sh

echo "üîç Running pre-commit checks..."

# 1. Type check production code (excludes test files)
echo "‚Üí Type checking production code..."
npx tsc --noEmit --project tsconfig.production.json || exit 1

# 2. Lint and format staged files
echo "‚Üí Linting and formatting..."
npx lint-staged || exit 1

# 3. Run unit tests
echo "‚Üí Running unit tests..."
npm test -- --passWithNoTests --bail || exit 1

# 4. Validate documentation
echo "‚Üí Validating documentation..."
node scripts/validate-docs.mjs || exit 1

# 5. Check for 'use client' in page.tsx or layout.tsx (Leaf Pattern)
echo "‚Üí Checking Leaf Pattern compliance..."
STAGED_FILES=$(git diff --cached --name-only)
CLIENT_IN_PAGES=$(echo "$STAGED_FILES" | grep -E "app/.*/page\.tsx|app/.*/layout\.tsx" | xargs grep -l "'use client'" 2>/dev/null || true)

if [ -n "$CLIENT_IN_PAGES" ]; then
  echo "‚ùå ERROR: Found 'use client' in page.tsx or layout.tsx"
  echo "Files:"
  echo "$CLIENT_IN_PAGES"
  echo ""
  echo "‚ö†Ô∏è  Violates Leaf Pattern - push 'use client' to leaf components only"
  exit 1
fi

echo "‚úÖ All pre-commit checks passed!"
