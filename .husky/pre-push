#!/usr/bin/env sh

echo ""
echo "ğŸš€ Running pre-push quality scan (FULL CODEBASE)..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# This runs a COMPREHENSIVE scan of the entire codebase before pushing
# Catches issues that might have slipped through pre-commit (e.g., old code)

# 1. Full TypeScript type check (production code only)
echo "ğŸ“‹ 1/5: Type checking entire codebase..."
npm run type-check:production || {
  echo ""
  echo "âŒ Type check failed!"
  echo "   Fix type errors before pushing."
  exit 1
}

# 2. Full ESLint scan (including 'any' type detection)
echo ""
echo "ğŸ” 2/5: Linting entire codebase (strict mode)..."
npm run lint:strict || {
  echo ""
  echo "âŒ Lint check failed!"
  echo "   Run 'npm run lint:fix' to auto-fix, or fix manually."
  exit 1
}

# 3. Run all unit tests
echo ""
echo "ğŸ§ª 3/5: Running all unit tests..."
npm test -- --passWithNoTests || {
  echo ""
  echo "âŒ Tests failed!"
  echo "   Fix failing tests before pushing."
  exit 1
}

# 4. Documentation & traceability validation
echo ""
echo "ğŸ“š 4/5: Validating documentation and traceability..."
node scripts/validate-docs.mjs || {
  echo ""
  echo "âŒ Documentation validation failed!"
  echo "   Update docs or fix traceability issues."
  exit 1
}

# 5. Security & compliance scan
echo ""
echo "ğŸ”’ 5/5: Running security checks..."

# Check for common security issues
SECURITY_ISSUES=0

# Check for hardcoded secrets (basic check)
if git diff --cached --name-only | xargs grep -E "sk_live|pk_live|sk_test.*[a-zA-Z0-9]{20}" 2>/dev/null; then
  echo "âš ï¸  WARNING: Possible API keys detected in staged files"
  SECURITY_ISSUES=$((SECURITY_ISSUES + 1))
fi

# Check for console.log in production code (except logger)
CONSOLE_LOGS=$(git diff --cached --diff-filter=ACM --name-only | grep -E '\.(ts|tsx)$' | grep -v '__tests__' | xargs grep -n 'console\.log' 2>/dev/null | grep -v 'logger' || true)
if [ -n "$CONSOLE_LOGS" ]; then
  echo "âš ï¸  WARNING: console.log found in production code (use logger instead):"
  echo "$CONSOLE_LOGS" | head -5
  SECURITY_ISSUES=$((SECURITY_ISSUES + 1))
fi

if [ $SECURITY_ISSUES -gt 0 ]; then
  echo ""
  echo "âš ï¸  Found $SECURITY_ISSUES security/quality warning(s)"
  echo "   Review the warnings above (non-blocking)"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… All pre-push checks passed! Safe to push."
echo ""

