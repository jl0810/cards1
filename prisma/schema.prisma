generator client {
  provider   = "prisma-client-js"
  output     = "../generated/prisma"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

model FamilyMember {
  id            String         @id @default(cuid())
  userId        String
  name          String
  email         String?
  avatar        String?
  color         String?
  role          String?        @default("Member")
  isPrimary     Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  user          UserProfile    @relation(fields: [userId], references: [id], onDelete: Cascade)
  plaidAccounts PlaidAccount[]
  plaidItems    PlaidItem[]

  @@map("family_members")
}

model Bank {
  id           String        @id @default(cuid())
  plaidId      String        @unique
  name         String
  logoUrl      String?
  brandColor   String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  cardProducts CardProduct[] @relation("BankCardProducts")
  plaidItems   PlaidItem[]   @relation("BankPlaidItems")

  @@map("banks")
}

model UserProfile {
  id                  String         @id @default(cuid())
  clerkId             String         @unique
  name                String?
  avatar              String?
  bio                 String?
  website             String?
  location            String?
  theme               String         @default("system")
  language            String         @default("en")
  timezone            String         @default("UTC")
  emailNotifications  Boolean        @default(true)
  pushNotifications   Boolean        @default(false)
  onboardingCompleted Boolean        @default(false)
  lastLoginAt         DateTime?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  analyticsSharing    Boolean        @default(true)
  autoSave            Boolean        @default(true)
  betaFeatures        Boolean        @default(false)
  compactMode         Boolean        @default(false)
  crashReporting      Boolean        @default(true)
  defaultDashboard    String         @default("main")
  keyboardShortcuts   Boolean        @default(true)
  marketingEmails     Boolean        @default(false)
  sidebarCollapsed    Boolean        @default(false)
  soundEffects        Boolean        @default(false)
  familyMembers       FamilyMember[]
  plaidItems          PlaidItem[]
  alerts              UserAlert[]

  // Enforce BR-001: All users must have valid Clerk IDs
  // Clerk IDs follow the format: user_[alphanumeric]
  // CHECK constraint added via manual migration (Prisma doesn't support @@check)
  @@map("user_profiles")
}

model UserAlert {
  id         String      @id @default(cuid())
  userId     String
  title      String
  message    String
  type       AlertType   @default(INFO)
  priority   Priority    @default(MEDIUM)
  isRead     Boolean     @default(false)
  expiresAt  DateTime?
  actionUrl  String?
  actionText String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  user       UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_alerts")
}

model PlaidItem {
  id              String             @id @default(cuid())
  userId          String
  itemId          String             @unique
  institutionId   String?
  institutionName String?
  status          String             @default("active")
  isTest          Boolean            @default(false)
  nextCursor      String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  accessTokenId   String             @unique
  familyMemberId  String
  lastSyncedAt    DateTime?
  bankId          String?            @map("bank_id")
  accounts        PlaidAccount[]
  bank            Bank?              @relation("BankPlaidItems", fields: [bankId], references: [id])
  familyMember    FamilyMember       @relation(fields: [familyMemberId], references: [id])
  user            UserProfile        @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions    PlaidTransaction[]

  @@map("plaid_items")
}

model PlaidAccount {
  id                      String             @id @default(cuid())
  plaidItemId             String
  accountId               String             @unique
  name                    String
  mask                    String?
  type                    String?
  subtype                 String?
  currentBalance          Float?
  availableBalance        Float?
  limit                   Float?
  isoCurrencyCode         String?
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  apr                     Float?
  lastStatementBalance    Float?
  lastStatementIssueDate  DateTime?
  minPaymentAmount        Float?
  nextPaymentDueDate      DateTime?
  aprBalanceSubjectToApr  Float?
  aprInterestChargeAmount Float?
  aprType                 String?
  isOverdue               Boolean?
  lastPaymentAmount       Float?
  lastPaymentDate         DateTime?
  familyMemberId          String
  officialName            String?
  extended                AccountExtended?
  benefitUsage            BenefitUsage[]
  familyMember            FamilyMember       @relation(fields: [familyMemberId], references: [id], onDelete: Cascade)
  plaidItem               PlaidItem          @relation(fields: [plaidItemId], references: [id], onDelete: Cascade)
  transactions            PlaidTransaction[]

  @@unique([familyMemberId, mask, officialName])
  @@map("plaid_accounts")
}

model AccountExtended {
  id             String       @id @default(cuid())
  plaidAccountId String       @unique
  cardProductId  String?
  nickname       String?
  isFavorite     Boolean      @default(false)
  sortOrder      Int?
  color          String?
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  dateOpened     DateTime?
  cardProduct    CardProduct? @relation(fields: [cardProductId], references: [id])
  plaidAccount   PlaidAccount @relation(fields: [plaidAccountId], references: [id], onDelete: Cascade)

  @@map("account_extended")
}

model PlaidTransaction {
  id                              String               @id @default(cuid())
  plaidItemId                     String
  transactionId                   String               @unique
  accountId                       String
  amount                          Float
  date                            DateTime
  name                            String
  merchantName                    String?
  category                        String[]
  pending                         Boolean              @default(false)
  createdAt                       DateTime             @default(now())
  updatedAt                       DateTime             @updatedAt
  originalDescription             String?
  paymentChannel                  String?
  personalFinanceCategoryDetailed String?
  personalFinanceCategoryPrimary  String?
  transactionCode                 String?
  account                         PlaidAccount         @relation(fields: [accountId], references: [accountId], onDelete: Cascade)
  plaidItem                       PlaidItem            @relation(fields: [plaidItemId], references: [id], onDelete: Cascade)
  extended                        TransactionExtended?

  @@map("plaid_transactions")
}

model TransactionExtended {
  id                   String           @id @default(cuid())
  plaidTransactionId   String           @unique
  matchedBenefitId     String?
  benefitUsageId       String?
  coveredAmount        Float?
  customCategory       String?
  notes                String?
  tags                 String[]
  isExcludedFromBudget Boolean          @default(false)
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  benefitUsage         BenefitUsage?    @relation(fields: [benefitUsageId], references: [id])
  matchedBenefit       CardBenefit?     @relation(fields: [matchedBenefitId], references: [id])
  plaidTransaction     PlaidTransaction @relation(fields: [plaidTransactionId], references: [id], onDelete: Cascade)

  @@map("transaction_extended")
}

model CardProduct {
  id                String            @id @default(cuid())
  issuer            String
  productName       String
  cardType          String?
  annualFee         Float?
  signupBonus       String?
  imageUrl          String?
  active            Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  bankId            String?           @map("bank_id")
  accountExtensions AccountExtended[]
  benefits          CardBenefit[]
  bank              Bank?             @relation("BankCardProducts", fields: [bankId], references: [id])

  @@unique([issuer, productName])
  @@map("card_products")
}

model CardBenefit {
  id                    String                @id @default(cuid())
  cardProductId         String
  benefitName           String
  timing                String
  maxAmount             Float?
  keywords              String[]
  active                Boolean               @default(true)
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  description           String?
  type                  BenefitType           @default(STATEMENT_CREDIT)
  isApproved            Boolean               @default(true)
  changeNotes           String?
  ruleConfig            Json?
  usageTracking         BenefitUsage[]
  cardProduct           CardProduct           @relation(fields: [cardProductId], references: [id], onDelete: Cascade)
  transactionExtensions TransactionExtended[]

  @@map("card_benefits")
}

model BenefitUsage {
  id                    String                @id @default(cuid())
  cardBenefitId         String
  plaidAccountId        String
  periodStart           DateTime
  periodEnd             DateTime
  maxAmount             Float
  usedAmount            Float                 @default(0)
  remainingAmount       Float
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  cardBenefit           CardBenefit           @relation(fields: [cardBenefitId], references: [id], onDelete: Cascade)
  plaidAccount          PlaidAccount          @relation(fields: [plaidAccountId], references: [id], onDelete: Cascade)
  transactionExtensions TransactionExtended[]

  @@unique([cardBenefitId, plaidAccountId, periodStart])
  @@map("benefit_usage")
}

enum AlertType {
  INFO
  SUCCESS
  WARNING
  ERROR
  MAINTENANCE
  FEATURE
  BILLING
  SECURITY
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum BenefitType {
  STATEMENT_CREDIT
  EXTERNAL_CREDIT
  INSURANCE
  PERK
}
